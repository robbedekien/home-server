version: "3.8"

services:

  # ===========================
  #   MYSQL DATABASE BACKUP
  # ===========================
  mysql-backup:
    image: tiredofit/db-backup
    container_name: backup_mysql
    environment:
      - DB_TYPE=mysql
      - DB_HOST=mysql                # working now because weâ€™re on debian_default
      - DB_USER=${DB_USERNAME}
      - DB_PASS=${DB_PASSWORD}
      - DB_NAME=${DB_DATABASE}
      - DB_DUMP_FREQ=1440            # daily
      - DB_CLEANUP_TIME=10080        # keep 7 days
      - COMPRESSION=gzip
    volumes:
      - /volume2/docker/backups/invoiceninja/mysql:/backup
    networks:
      - debian_default
    restart: unless-stopped


  # ===========================
  #   LARAVEL STORAGE BACKUP
  # ===========================
  storage-backup:
    image: offen/docker-volume-backup:v2                  # use a fixed release tag (v2) for stability
    container_name: storage-backup
    restart: always
    user: "1026:100"
    environment:
      BACKUP_CRON_EXPRESSION: "0 2 * * *"                 # run daily at 2:00 AM
      BACKUP_RETENTION_DAYS: "7"                          # retain backups for 7 days
      BACKUP_FILENAME: "storage-backup-%Y-%m-%d.tar.gz"   # daily archive name format
      BACKUP_PRUNING_PREFIX: "storage-backup-"            # only delete files with this prefix
    volumes:
      - debian_app_storage:/backup:ro                     # **Source**: Laravel storage directory (read-only)
      - /volume2/docker/backups/invoiceninja/storage:/archive    # **Destination**: Host backup folder


volumes:
  debian_app_storage:
    external: true

networks:
  debian_default:
    external: true
